class Character{constructor(_name,_color){this.name=_name,this.color=_color}}class Task{constructor(){this.id=""}start(){}update(delta){}skip(){}end(){console.log("[ID: "+this.id+"] 태스크가 끝났습니다."),this.skip(),taskManager.disposeTask(this.id)}}class Vector2{constructor(_x,_y){this.x=parseFloat(_x),this.y=parseFloat(_y)}}class GameObject{constructor(_image,_pos_X,_pos_Y,_pos_Z,_width,_height){this.image=_image,this.position=new Vector2(parseFloat(_pos_X),parseFloat(_pos_Y)),this.z_index=_pos_Z,this.scale=new Vector2,this.scale.x=1,this.scale.y=1,this.opacity=parseFloat(1),this.width=null==_width||null==_width?this.image.width:_width,this.height=null==_height||null==_height?this.image.height:_height,this.isVisible=!0,this.parent=null}changeImage(source){this.image=source,this.width=this.image.width,this.height=this.image.height}changeVisibility(flag){this.isVisible=flag}}class Command{constructor(_command,_paramters){this.command=_command,this.parameters=_paramters}}Math.AddVector2=function(v1,v2){return new Vector2(v1.x+v2.x,v1.y+v2.y)},Math.MinusVector2=function(v1,v2){return new Vector2(v1.x-v2.x,v1.y-v2.y)},Math.MultiVector2=function(v,scalar){return new Vector2(v.x*scalar,v.y*scalar)},Math.Vector2Distance=function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))},Math.Vector2Magnitude=function(v){return Math.sqrt(Math.pow(v.x,2)+Math.pow(v.y,2))},Math.Vector2MoveTowards=function(current,target,maxDistanceDelta){var a=Math.MinusVector2(target,current),magnitude=Math.Vector2Magnitude(a);return magnitude<=maxDistanceDelta||0==magnitude?target:Math.AddVector2(Math.MultiVector2(new Vector2(a.x/magnitude,a.y/magnitude),maxDistanceDelta),current)},Math.LerpVector2=function(v1,v2,amt){return Math.AddVector2(Math.MultiVector2(v1,1-amt),Math.MultiVector2(v2,amt))};let defines=new Array;const defineCommandList=new Map([["CHAR",defineCharacter],["IMG",defineImage]]),CommandList=new Map([["PRINT",print],["SHOW",showImage],["HIDE",hideImage],["DISPOSE",disposeObject],["FADE",fadeObject],["SCALE",setObjectScale],["MOVE_LERP",lerpMove],["MOVE",moveToward],["SET_BG",setBackground],["BOUNCE",bounceObject],["SHAKE",shakeObject]]);let scriptHandler={scriptSections:new Array,cursor:0,getNextScriptSection:function(){return this.cursor+=1,this.cursor-1>this.scriptSections.length?null:this.scriptSections[this.cursor-1]}},textHandler={speaker:null,currentText:"",wrapText:function(text,x,y,maxWidth,lineHeight){for(var words=text.split(""),line="",n=0;n<words.length;n++){var textLine=line+words[n]+"",metrics,textWidth;ctx.measureText(textLine).width>maxWidth&&n>0||"\n"==words[n]?(ctx.fillText(line,x,y),line=words[n]+"","\n"==words[n]&&(line=""),y+=lineHeight):line=textLine}ctx.fillText(line,x,y)}},Memory={characters:new Map,images:new Map,objects:new Map,task:new Map},Resource={},dumpedMemory=new Array,option={FPS:60,width:720,height:1280,fontSize:38,nameSize:24,canvasDebug:!1,dialogueSpeed:.07},textBoxSetting={width:680,height:320,name_xPos:50,name_yPos:20,padding:{}};textBoxSetting.padding.top=90,textBoxSetting.padding.left=75,textBoxSetting.padding.right=75,textBoxSetting.padding.bottom=20,textBoxSetting.margin={},textBoxSetting.margin.bottom=10;let baseAspectRatio=0,stop=!1,frameCount=0,$canvas=document.getElementById("canvas"),$container=document.getElementsByClassName("container"),consoleRoot=document.getElementById("console"),ctx,fps,fpsInterval,startTime,now,then,elapsed,deltaNow,deltaPrev,originScript=null,blockNext=!1;var fontSetting={currentSize:0,fontInfo:""},currentCanvasScale={x:1,y:1};let textBox={x:0,y:0,width:0,height:0,padding_x:0,padding_y:0};function play(sourceUrl){loadScript(sourceUrl),init()}function init(){fps=option.FPS,fpsInterval=1e3/fps,$canvas=document.getElementById("canvas"),$container=document.getElementsByClassName("container"),consoleRoot=document.getElementById("console"),ctx=$canvas.getContext("2d"),ctx.font="",resizeGame(),translateScript(originScript),start()}async function start(){await preDefines(),excuteCodeLines(),console.log(fpsInterval),then=Date.now(),startTime=then,prev=then,deltaPrev=Date.now(),loop()}function loop(){requestAnimationFrame(loop),now=Date.now(),elapsed=now-then;var prev=Date.now();if(elapsed>=fpsInterval){then=now-elapsed%fpsInterval;var sinceStart=now-startTime,delta=(now-deltaPrev)/1e3;deltaPrev=now,update(delta),draw()}}function update(delta){0!==Memory.task.size||blockNext||executeNext(),taskManager.updateTasks(delta)}function draw(){ctx.clearRect(0,0,$canvas.width,$canvas.height),ctx.globalAlpha=1,ctx.save(),Memory.objects.forEach(element=>{if(element.isVisible){var flipX=element.scale.x>=0?1:-1,flipY=element.scale.y>=0?1:-1,originalXPosition=element.position.x,originalYPosition=element.position.y,flipedPosition=new Vector2(element.position.x,element.position.y);ctx.globalAlpha=element.opacity,ctx.scale(flipX,flipY),-1==flipX&&(flipedPosition.x=flipedPosition.x-2*flipedPosition.x),-1==flipY&&(flipedPosition.y=flipedPosition.y-2*flipedPosition.y);var fixedWidth=element.width*element.scale.x,fixedHeight=element.height*element.scale.y,fixedX=flipedPosition.x-fixedWidth/2,fixedY=flipedPosition.y-fixedHeight/2;ctx.drawImage(element.image,fixedX*currentCanvasScale.x,fixedY*currentCanvasScale.y,fixedWidth*currentCanvasScale.x,fixedHeight*currentCanvasScale.y),option.canvasDebug&&(ctx.fillStyle="rgba(255,0,0,.5)",ctx.fillRect(fixedX*currentCanvasScale.x,fixedY*currentCanvasScale.y,fixedWidth*currentCanvasScale.x,fixedHeight*currentCanvasScale.y)),ctx.setTransform(1,0,0,1,0,0),ctx.stroke(),ctx.restore()}ctx.globalAlpha=1});var textBoxPos_x=option.width/2-textBoxSetting.width/2,textBoxPos_y=option.height-textBoxSetting.height-textBoxSetting.margin.bottom;option.canvasDebug&&(ctx.fillStyle="green",ctx.fillRect(textBoxPos_x*currentCanvasScale.x,textBoxPos_y*currentCanvasScale.y,textBoxSetting.width*currentCanvasScale.x,textBoxSetting.height*currentCanvasScale.y),ctx.fillStyle="red",ctx.fillRect(dialogueAreaPos_x*currentCanvasScale.x,dialogueAreaPos_y*currentCanvasScale.y,(textBoxSetting.width-textBoxSetting.padding.left-textBoxSetting.padding.right)*currentCanvasScale.x,(textBoxSetting.height-textBoxSetting.padding.top-textBoxSetting.padding.bottom)*currentCanvasScale.y)),ctx.fillStyle="rgba(0,0,0,.7)",ctx.fillRect(textBoxPos_x*currentCanvasScale.x,textBoxPos_y*currentCanvasScale.y,textBoxSetting.width*currentCanvasScale.x,textBoxSetting.height*currentCanvasScale.y);var dialogueAreaPos_x=textBoxPos_x+textBoxSetting.padding.left,dialogueAreaPos_y=textBoxPos_y+textBoxSetting.padding.top;null!=textHandler.speaker&&(ctx.fillStyle=textHandler.speaker.color,ctx.fillText(textHandler.speaker.name,(textBoxPos_x+textBoxSetting.name_xPos)*currentCanvasScale.x,(textBoxPos_y+textBoxSetting.name_yPos)*currentCanvasScale.y+fontSetting.currentSize)),ctx.fillStyle="white",ctx.font=fontSetting.fontInfo,textHandler.wrapText(textHandler.currentText,dialogueAreaPos_x*currentCanvasScale.x,dialogueAreaPos_y*currentCanvasScale.y+fontSetting.currentSize,(textBoxSetting.width-textBoxSetting.padding.left-textBoxSetting.padding.right)*currentCanvasScale.x,fontSetting.currentSize),ctx.stroke()}var calculateAspectRatioFit=function(srcWidth,srcHeight,maxWidth,maxHeight){var ratio=Math.min(maxWidth/srcWidth,maxHeight/srcHeight);return{width:srcWidth*ratio,height:srcHeight*ratio}};function calculateFontSize(){var ratio=option.fontSize/option.width,size=$canvas.width*ratio;fontSetting.currentSize=0|size,fontSetting.fontInfo=fontSetting.currentSize+"px NanumBarunGothic"}function gcd(a,b){return 0==b?a:gcd(b,a%b)}function resizeGame(){var ratio=gcd(option.width,option.height),widthToHeight=option.width/ratio/(option.height/ratio),newWidth=window.innerWidth,newHeight=window.innerHeight,newWidthToHeight;newWidth/newHeight>widthToHeight?(newWidth=newHeight*widthToHeight,$canvas.style.height=newHeight+"px",$canvas.style.width=newWidth+"px"):(newHeight=newWidth/widthToHeight,$canvas.style.width=newWidth+"px",$canvas.style.height=newHeight+"px"),$canvas.style.marginTop=-newHeight/2+"px",$canvas.style.marginLeft=-newWidth/2+"px",$canvas.width=newWidth,$canvas.height=newHeight,currentCanvasScale.x=parseFloat($canvas.width/option.width).toFixed(3),currentCanvasScale.y=parseFloat($canvas.height/option.height).toFixed(3),calculateFontSize()}function initializeCanvasSize(){$canvas.width=option.width,$canvas.height=option.height,baseAspectRatio=option.width/option.height}function convertPercentagePosition(_x,_y){return CheckPercentageNumber(_x)&&(_x=_x.replace("%","")),CheckPercentageNumber(_y)&&(_y=_y.replace("%","")),{x:option.width/100*_x,y:option.height/100*_y}}function settingTextbox(y_pos,padding_x,padding_y){textBox.x=0,textBox.y=convertPercentagePosition(0,y_pos).y,textBox.width=$canvas.width,textBox.height=convertPercentagePosition(0,100-y_pos).y,textBox.padding_x=textBox.width/100*3,textBox.padding_y=textBox.height/100*5}function initializeScreen(){}function debugPrinter(text){var log;document.createElement("p").innerHTML=text}function dumpMemory(){var dump=Memory;dumpedMemory.push(dump)}function CheckPercentageNumber(number){const percentageRegex=/([0-9]+)(\.?[0-9]+)?%/;return"string"==typeof number&&percentageRegex.test(number.toString())}window.onresize=function(){clearTimeout(resizeGame()),doit=setTimeout((function(){resizeGame()}),100)},document.addEventListener("keyup",event=>{if("Space"===event.code){if(0!=Memory.task.size)return void taskManager.skipTasks();blockNext=!1}"D"==event.code&&dumpMemory(),"Q"==event.code&&(console.log("캔버스 디버그 활성화"),option.debugPrinter=!option.debugPrinter)}),document.addEventListener("touchstart",event=>{0==Memory.task.size?blockNext=!1:taskManager.skipTasks()},!0);let taskManager={};function executeNext(){excuteCodeLines()}function defineCharacter(name,personalColor){Memory.characters.set(name.replace(" ",""),new Character(name,personalColor))}async function defineImage(name,sourceUrl){await loadingImage(sourceUrl).then(img=>Memory.images.set(name.replace(" ",""),img))}async function loadingImage(src){return new Promise((resolve,reject)=>{let img=new Image;img.addEventListener("load",e=>resolve(img)),img.addEventListener("error",()=>{reject(new Error(`Failed to load image's URL: ${sourceUrl}`))}),img.src=src})}function print(name,text,cycleTime){var speaker=Memory.characters.get(name);null==cycleTime&&(cycleTime=option.dialogueSpeed),textHandler.speaker=speaker,blockNext=!0;var task=new Task;console.warn(text),task.originText=text.replace(/^\"|\"$/g,"").replace(/\\n/g,"\n"),console.warn(task.originText),task.cycleTime=parseFloat(cycleTime),task.timeStore=0,task.cursor=1,task.update=function(delta){this.timeStore+=delta,this.timeStore>=this.cycleTime&&(this.cursor+=parseInt(this.timeStore/this.cycleTime),this.cursor>=this.originText.length&&this.end(),this.timeStore=0),textHandler.currentText=this.originText.slice(0,this.cursor)},task.skip=function(){textHandler.currentText=this.originText},taskManager.registTask(task)}function showImage(name,imageName,pos_x,pos_y,pos_z){var already=Memory.objects.get(name),img=Memory.images.get(imageName),percentageRegex=/([0-9]+)(\.?[0-9]+)?%/;null!=pos_x&&null!=pos_y&&(percentageRegex.test(pos_x.toString())&&(pos_x=convertPercentagePosition(parseFloat(pos_x.replace("%","")),0).x),percentageRegex.test(pos_y.toString())&&(pos_y=convertPercentagePosition(0,parseFloat(pos_y.replace("%",""))).y)),null==img&&console.error("["+imageName+"] 이미지는 존재하지 않습니다.");var targetObj=already;null==already&&(targetObj=new GameObject(img,pos_x,pos_y)),targetObj.changeImage(img),Memory.objects.set(name,targetObj),debugPrinter("Object image Changed on memory (name:"+name+", resource:"+imageName+")")}function hideImage(name){Memory.objects.get(name).changeVisibility(!1)}function disposeObject(name){debugPrinter("dispose Object on memory (name:"+name+")")}function fadeObject(name,start,to,speed){var task=new Task;task.targetObj=null,task.startOpt=null,task.endOpt=null,task.speed=null,task.start=function(){task.targetObj=Memory.objects.get(name),task.startOpt=null==start?parseFloat(this.targetObj.opacity):parseFloat(start),task.endOpt=parseFloat(to),task.targetObj.opacity=task.startOpt,task.speed=parseFloat(speed)*(this.startOpt>this.endOpt?-1:1)},task.update=function(delta){this.targetObj.opacity+=this.speed*delta,this.startOpt<=this.endOpt?this.targetObj.opacity>=this.endOpt&&this.end():this.targetObj.opacity<=this.endOpt&&this.end()},task.skip=function(){this.targetObj.opacity=this.endOpt},taskManager.registTask(task)}function setBackground(imageName){var centerPos=convertPercentagePosition(50,50),bgObject=new GameObject(Memory.images.get(imageName),centerPos.x,centerPos.y,1,option.width,option.height);bgObject.z_index=0,Memory.objects.set("BG",bgObject)}function setObjectScale(name,scale_x,sacle_y){var target=Memory.objects.get(name);null!=target?(target.scale.x=parseFloat(scale_x),target.scale.y=parseFloat(sacle_y)):console.error("스케일을 변경할 오브젝트가 메모리에 존재하지않습니다.")}function moveToward(name,target_x,target_y,speed){var task=new Task;task.targetObj=null,task.target_pos={},task.target_pos.x=null,task.target_pos.y=null,task.speed=null,task.start=function(){this.targetObj=Memory.objects.get(name),this.target_pos.x=parseFloat(CheckPercentageNumber(target_x)?convertPercentagePosition(target_x,0).x:target_x),this.target_pos.y=parseFloat(CheckPercentageNumber(target_y)?convertPercentagePosition(0,target_y).y:target_y),this.speed=40*parseInt(speed)},task.update=function(delta){var newPos=Math.Vector2MoveTowards(new Vector2(this.targetObj.position.x,this.targetObj.position.y),this.target_pos,this.speed*delta);this.targetObj.position.x=newPos.x,this.targetObj.position.y=newPos.y,newPos==this.target_pos&&(console.log("MoveToward 연산종료"),this.end())},task.skip=function(){this.targetObj.position.x=this.target_pos.x,this.targetObj.position.y=this.target_pos.y},taskManager.registTask(task)}function lerpMove(name,target_x,target_y,speed){var task=new Task;task.targetObj=null,task.target_pos={},task.target_pos.x=null,task.target_pos.y=null,task.speed=null,task.start=function(){task.targetObj=Memory.objects.get(name),task.target_pos.x=parseFloat(CheckPercentageNumber(target_x)?convertPercentagePosition(target_x,0).x:target_x),task.target_pos.y=parseFloat(CheckPercentageNumber(target_y)?convertPercentagePosition(0,target_y).y:target_y),task.speed=parseInt(speed)},task.update=function(delta){this.targetObj.position==this.target_pos&&(console.log("lerp Move 종료"),this.end());var newPos=Math.LerpVector2(this.targetObj.position,this.target_pos,this.speed*delta);this.targetObj.position.x!=this.target_pos.x&&(Math.abs(Math.abs(this.targetObj.position.x)-Math.abs(this.target_pos.x))<=1?(this.targetObj.position.x=this.target_pos.x,console.log("x 증가 끝")):this.targetObj.position.x=newPos.x),this.targetObj.position.y!=this.target_pos.y&&(Math.abs(Math.abs(this.targetObj.position.y)-Math.abs(this.target_pos.y))<=1?this.targetObj.position.y=this.target_pos.y:this.targetObj.position.y=newPos.y)},task.skip=function(){this.targetObj.position.x=this.target_pos.x,this.targetObj.position.y=this.target_pos.y},taskManager.registTask(task)}function bounceObject(name,height,speed,duration){var task=new Task;task.targetObject=null,task.targetHeight=null,task.startPosition_y=null,task.speed=null,task.duration=null,task.durationStore=null,task.direction=null,task.timeStore=null,task.start=function(){this.targetObject=Memory.objects.get(name),this.targetHeight=parseFloat(height),this.startPosition_y=parseFloat(this.targetObject.position.y),this.speed=parseInt(speed),this.duration=duration,this.durationStore=0,this.timeStore=0,this.direction=this.targetHeight/Math.abs(this.targetHeight)},task.update=function(delta){var time=delta*this.speed;this.timeStore+=time;var inc=Math.sin(this.timeStore)*this.targetHeight,detecting=Math.abs(inc);this.targetObject.position.y=this.startPosition_y+inc,(-1==this.direction?inc>=0:inc<=0)&&(this.timeStore=0,this.targetObject.position.y=this.startPosition_y,this.durationStore+=1,this.duration<=this.durationStore&&this.end())},task.skip=function(){this.targetObject.position.y=this.startPosition_y},taskManager.registTask(task)}function shakeObject(name,distance,speed,duration){var task=new Task;task.targetObject=null,task.distance=null,task.startX=null,task.speed=null,task.duration=null,task.durationStore=null,task.direction=null,task.timeStore=null,task.start=function(){this.targetObject=Memory.objects.get(name),this.distance=parseFloat(distance),this.startX=parseFloat(this.targetObject.position.x),this.speed=parseInt(speed),this.duration=duration,this.durationStore=0,this.timeStore=0,this.direction=this.distance/Math.abs(this.distance)},task.update=function(delta){var time=delta*this.speed;this.timeStore+=time;var inc=Math.sin(this.timeStore)*this.distance,detecting=Math.abs(inc);this.targetObject.position.x=this.startX+inc,(-1==this.direction?inc>=0:inc<=0)&&(this.direction*=-1,this.durationStore+=1,2*this.duration<=this.durationStore&&this.end())},task.skip=function(){this.targetObject.position.x=this.startX},taskManager.registTask(task)}function zoomObject(name,startScale,endScale,speed){var task=new Task;task.targetObject=null,task.startScale=null,task.endScale=null,task.speed=null,task.start=function(){this.targetObject=Memory.objects.get(name),this.startScale=parseFloat(startScale),this.endScale=parseFloat(endScale),this.speed=parseFloat(speed)},task.update=function(delta){},task.skip=function(){this.targetObject.scale=this.endScale}}function loadScript(file){var rawFile=new XMLHttpRequest;rawFile.open("GET",file,!1),rawFile.onreadystatechange=function(){if(4===rawFile.readyState&&(200===rawFile.status||0==rawFile.status)){var allText=rawFile.responseText;originScript=allText}},rawFile.send(null)}function translateScript(originCode){var codeSections;originCode.split(/\n\n|\r\n\r\n/).forEach(eachSection=>{var splitedCodeLine=eachSection.split(/\n|\r\n/),eachCommand=new Array,codeLines=new Array;splitedCodeLine.forEach(eachLine=>{var paramRegex=/\((.*)\)/;if(console.log(eachLine),eachLine.length<=0)console.log("its empty string");else{var parameterSet,parameters=paramRegex.exec(eachLine)[1].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g),command=eachLine.replace(paramRegex,""),trimedParameters=parameters=>parameters.map(element=>("null"==(element=element.trim())&&(element=null),element)),codeLineObj=new Command(command.trim(),trimedParameters(parameters));defineCommandList.has(codeLineObj.command)?defines.push(codeLineObj):codeLines.push(codeLineObj)}}),scriptHandler.scriptSections.push(codeLines)}),console.log("Structing Command Complete")}function excuteCodeLines(){console.log("코드라인 실행");var codeLines=scriptHandler.getNextScriptSection();null!=codeLines&&codeLines.forEach(codeLine=>{var command=CommandList.get(codeLine.command),excute;null==command&&console.error("["+codeLine.command+"]는 지원하지 않는 명령어 입니다."),command.apply.bind(command,null,codeLine.parameters)()})}async function preDefines(){let imgCommands=new Array;var trimedParameters=parameters=>parameters.map(element=>element.trim());defines.forEach(define=>{var command=defineCommandList.get(define.command),excute;(define.parameters=trimedParameters(define.parameters),command!=defineImage)?(null==command&&console.error("["+define.command+"]는 지원하지 않는 명령어 입니다."),command.apply.bind(command,null,define.parameters)()):imgCommands.push(define)}),await preloadingImages(imgCommands)}async function preloadingImages(imgList){for(var i=0;i<imgList.length;i++)await defineImage(imgList[i].parameters[0],imgList[i].parameters[1])}taskManager.registTask=function(_task){for(var result="",characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",charactersLength=characters.length,i=0;i<7;i++)result+=characters.charAt(Math.floor(Math.random()*charactersLength));_task.id=result,_task.start(),Memory.task.set(result,_task)},taskManager.updateTasks=function(delta){Memory.task.forEach(task=>{task.update(delta)})},taskManager.skipTasks=function(){Memory.task.forEach(task=>{task.end()})},taskManager.disposeTask=function(id){Memory.task.delete(id)};